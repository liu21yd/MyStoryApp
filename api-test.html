<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyStoryApp API æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #007AFF;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status.online {
            background: #d4edda;
            color: #155724;
        }
        
        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .progress {
            margin-top: 15px;
        }
        
        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #007AFF;
            transition: width 0.3s;
        }
        
        .progress-text {
            margin-top: 5px;
            font-size: 13px;
            color: #666;
        }
        
        audio, video {
            width: 100%;
            margin-top: 10px;
            border-radius: 8px;
        }
        
        img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .api-url {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ MyStoryApp API æµ‹è¯•å·¥å…·</h1>
        
        <!-- æœåŠ¡å™¨é…ç½® -->
        <div class="card">
            <h2>âš™ï¸ æœåŠ¡å™¨é…ç½®</h2>
            <div class="form-group">
                <label>API åœ°å€</label>
                <input type="text" id="apiUrl" value="http://localhost:3000/api/v1" placeholder="http://localhost:3000/api/v1">
            </div>
            <button onclick="checkHealth()">æ£€æŸ¥è¿æ¥</button>
            <div id="healthResult"></div>
        </div>
        
        <!-- TTS æµ‹è¯• -->
        <div class="card">
            <h2>ğŸ¤ è¯­éŸ³åˆæˆ (TTS)</h2>
            <div class="form-group">
                <label>æ–‡æœ¬å†…å®¹</label>
                <textarea id="ttsText" placeholder="è¾“å…¥è¦åˆæˆçš„æ–‡å­—...">æ¬¢è¿ä½¿ç”¨æˆ‘çš„æ•…äº‹åº”ç”¨ï¼Œè¿™æ˜¯ç™¾ç‚¼è¯­éŸ³åˆæˆæµ‹è¯•ã€‚</textarea>
            </div>
            <div class="form-group">
                <label>è¯­éŸ³è§’è‰²</label>
                <select id="ttsVoice">
                    <option value="standardFemale">çŸ¥ç”œ - æ¸©æŸ”å¥³å£°</option>
                    <option value="standardMale">çŸ¥å“² - æ ‡å‡†ç”·å£°</option>
                    <option value="gentleFemale">çŸ¥æ ‘ - æŸ”å’Œå¥³å£°</option>
                    <option value="deepMale">çŸ¥è¾¾ - ç£æ€§ç”·å£°</option>
                    <option value="child">çŸ¥å¦™ - ç«¥å£°</option>
                    <option value="cartoon">çŸ¥é£ - æ´»æ³¼å¥³å£°</option>
                </select>
            </div>
            <div class="form-group">
                <label>è¯­é€Ÿ: <span id="speedValue">1.0</span></label>
                <input type="range" id="ttsSpeed" min="0.5" max="2.0" step="0.25" value="1.0" oninput="document.getElementById('speedValue').textContent=this.value">
            </div>
            <button onclick="testTTS()">ç”Ÿæˆè¯­éŸ³</button>
            <div id="ttsResult"></div>
        </div>
        
        <!-- å›¾ç‰‡æ‰©å±•æµ‹è¯• -->
        <div class="card">
            <h2>ğŸ–¼ï¸ å›¾ç‰‡æ‰©å±•</h2>
            <div class="form-group">
                <label>é€‰æ‹©å›¾ç‰‡</label>
                <input type="file" id="imageFile" accept="image/*">
            </div>
            <div class="form-group">
                <label>æ‰©å±•é£æ ¼</label>
                <select id="imageStyle">
                    <option value="cinematic">ç”µå½±æ„Ÿ</option>
                    <option value="anime">åŠ¨æ¼«é£</option>
                    <option value="realistic">å†™å®é£</option>
                    <option value="dreamy">æ¢¦å¹»é£</option>
                    <option value="vintage">å¤å¤é£</option>
                    <option value="artistic">è‰ºæœ¯é£</option>
                </select>
            </div>
            <button onclick="testImageExpand()">æ‰©å±•å›¾ç‰‡</button>
            <div id="imageResult"></div>
        </div>
        
        <!-- è§†é¢‘ç”Ÿæˆæµ‹è¯• -->
        <div class="card">
            <h2>ğŸ¬ è§†é¢‘ç”Ÿæˆ</h2>
            <div class="form-group">
                <label>è§†é¢‘æ ‡é¢˜</label>
                <input type="text" id="videoTitle" value="æµ‹è¯•è§†é¢‘" placeholder="è¾“å…¥è§†é¢‘æ ‡é¢˜">
            </div>
            
            <div class="form-group">
                <label>å¹»ç¯ç‰‡ 1 - å›¾ç‰‡URL</label>
                <input type="text" id="slide1Image" value="https://picsum.photos/1280/720" placeholder="å›¾ç‰‡URL">
                <label style="margin-top: 8px;">å­—å¹•</label>
                <input type="text" id="slide1Caption" value="ç¬¬ä¸€å¼ å¹»ç¯ç‰‡" placeholder="å­—å¹•æ–‡å­—">
                <label style="margin-top: 8px;">é…éŸ³æ–‡æœ¬</label>
                <input type="text" id="slide1Voice" value="è¿™æ˜¯ç¬¬ä¸€å¼ å¹»ç¯ç‰‡çš„é…éŸ³å†…å®¹ã€‚" placeholder="é…éŸ³æ–‡å­—">
            </div>
            
            <div class="form-group">
                <label>å¹»ç¯ç‰‡ 2 - å›¾ç‰‡URL</label>
                <input type="text" id="slide2Image" value="https://picsum.photos/1280/721" placeholder="å›¾ç‰‡URL">
                <label style="margin-top: 8px;">å­—å¹•</label>
                <input type="text" id="slide2Caption" value="ç¬¬äºŒå¼ å¹»ç¯ç‰‡" placeholder="å­—å¹•æ–‡å­—">
                <label style="margin-top: 8px;">é…éŸ³æ–‡æœ¬</label>
                <input type="text" id="slide2Voice" value="è¿™æ˜¯ç¬¬äºŒå¼ å¹»ç¯ç‰‡çš„é…éŸ³å†…å®¹ã€‚" placeholder="é…éŸ³æ–‡å­—">
            </div>
            
            <div class="form-group">
                <label>é…ç½®</label>
                <select id="videoResolution">
                    <option value="720p">720p HD</option>
                    <option value="1080p">1080p Full HD</option>
                    <option value="480p">480p SD</option>
                </select>
            </div>
            
            <button onclick="createVideo()">åˆ›å»ºè§†é¢‘</button>
            <div id="videoResult"></div>
        </div>
    </div>

    <script>
        const API_URL = () => document.getElementById('apiUrl').value.replace(/\/$/, '');
        
        // æ£€æŸ¥å¥åº·çŠ¶æ€
        async function checkHealth() {
            const resultDiv = document.getElementById('healthResult');
            resultDiv.innerHTML = '<div class="result">æ£€æŸ¥ä¸­...</div>';
            
            try {
                const response = await fetch(API_URL().replace('/api/v1', '') + '/health');
                const data = await response.json();
                
                if (data.status === 'ok') {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… æœåŠ¡å™¨åœ¨çº¿\nç‰ˆæœ¬: ${data.version}\næ—¶é—´: ${data.timestamp}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        âŒ è¿æ¥å¤±è´¥\n${error.message}\n\nè¯·ç¡®ä¿ï¼š\n1. åç«¯æœåŠ¡å·²å¯åŠ¨ (npm run dev)\n2. Redis å·²å¯åŠ¨\n3. API åœ°å€æ­£ç¡®
                    </div>
                `;
            }
        }
        
        // æµ‹è¯• TTS
        async function testTTS() {
            const resultDiv = document.getElementById('ttsResult');
            const text = document.getElementById('ttsText').value;
            const voiceType = document.getElementById('ttsVoice').value;
            const speed = parseFloat(document.getElementById('ttsSpeed').value);
            
            resultDiv.innerHTML = '<div class="result">ç”Ÿæˆä¸­...</div>';
            
            try {
                const response = await fetch(`${API_URL()}/tts/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, voiceType, speed })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… ç”ŸæˆæˆåŠŸ\næ—¶é•¿: ${data.data.duration.toFixed(1)}s\nåœ°å€: ${data.data.audioUrl}
                        </div>
                        <audio controls src="${data.data.audioUrl}"></audio>
                    `;
                } else {
                    throw new Error(data.error?.message || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ ${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•å›¾ç‰‡æ‰©å±•
        async function testImageExpand() {
            const resultDiv = document.getElementById('imageResult');
            const fileInput = document.getElementById('imageFile');
            const style = document.getElementById('imageStyle').value;
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="result error">âŒ è¯·é€‰æ‹©å›¾ç‰‡</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="result">æ‰©å±•ä¸­... (å¯èƒ½éœ€è¦10-30ç§’)</div>';
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('style', style);
            
            try {
                const response = await fetch(`${API_URL()}/image/expand`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… æ‰©å±•æˆåŠŸ\nåœ°å€: ${data.data.expandedImageUrl}
                        </div>
                        <img src="${data.data.expandedImageUrl}" alt="æ‰©å±•åçš„å›¾ç‰‡">
                    `;
                } else {
                    throw new Error(data.error?.message || 'æ‰©å±•å¤±è´¥');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ ${error.message}</div>`;
            }
        }
        
        // åˆ›å»ºè§†é¢‘
        async function createVideo() {
            const resultDiv = document.getElementById('videoResult');
            
            const payload = {
                title: document.getElementById('videoTitle').value,
                description: 'æµ‹è¯•è§†é¢‘',
                slides: [
                    {
                        imageUrl: document.getElementById('slide1Image').value,
                        caption: document.getElementById('slide1Caption').value,
                        voiceText: document.getElementById('slide1Voice').value,
                        duration: 5,
                        transition: 'fade'
                    },
                    {
                        imageUrl: document.getElementById('slide2Image').value,
                        caption: document.getElementById('slide2Caption').value,
                        voiceText: document.getElementById('slide2Voice').value,
                        duration: 5,
                        transition: 'slideLeft'
                    }
                ],
                config: {
                    resolution: document.getElementById('videoResolution').value,
                    frameRate: 30,
                    voiceType: 'standardFemale',
                    voiceSpeed: 1.0,
                    backgroundMusic: 'gentle',
                    subtitleEnabled: true,
                    subtitlePosition: 'bottom',
                    aiImageExpansion: false,
                    expansionStyle: 'cinematic'
                }
            };
            
            resultDiv.innerHTML = '<div class="result">åˆ›å»ºä»»åŠ¡ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_URL()}/video/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const taskId = data.data.taskId;
                    resultDiv.innerHTML = `
                        <div class="result success">
                            âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ\nä»»åŠ¡ID: ${taskId}\né¢„è®¡æ—¶é—´: ${data.data.estimatedTime}s
                        </div>
                        <div class="progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="videoProgress" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="videoStatus">ç­‰å¾…ä¸­...</div>
                        </div>
                    `;
                    
                    // å¼€å§‹è½®è¯¢
                    pollVideoStatus(taskId);
                } else {
                    throw new Error(data.error?.message || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ ${error.message}</div>`;
            }
        }
        
        // è½®è¯¢è§†é¢‘çŠ¶æ€
        async function pollVideoStatus(taskId) {
            const maxAttempts = 60;
            let attempts = 0;
            
            const interval = setInterval(async () => {
                attempts++;
                
                try {
                    const response = await fetch(`${API_URL()}/video/status/${taskId}`);
                    const data = await response.json();
                    
                    if (!data.success) {
                        clearInterval(interval);
                        document.getElementById('videoStatus').textContent = 'æŸ¥è¯¢å¤±è´¥';
                        return;
                    }
                    
                    const status = data.data;
                    const progress = Math.round(status.progress * 100);
                    
                    document.getElementById('videoProgress').style.width = `${progress}%`;
                    document.getElementById('videoStatus').textContent = 
                        `${progress}% - ${status.message}`;
                    
                    if (status.status === 'completed') {
                        clearInterval(interval);
                        document.getElementById('videoResult').innerHTML += `
                            <div class="result success" style="margin-top: 10px;">
                                âœ… è§†é¢‘ç”Ÿæˆå®Œæˆï¼
                            </div>
                            <video controls src="${status.outputUrl}"></video>
                        `;
                    } else if (status.status === 'failed') {
                        clearInterval(interval);
                        document.getElementById('videoStatus').textContent = 'ç”Ÿæˆå¤±è´¥';
                        document.getElementById('videoResult').innerHTML += `
                            <div class="result error" style="margin-top: 10px;">
                                âŒ ${status.error || 'ç”Ÿæˆå¤±è´¥'}
                            </div>
                        `;
                    }
                    
                    if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        document.getElementById('videoStatus').textContent = 'è¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨æŸ¥è¯¢';
                    }
                } catch (error) {
                    console.error('è½®è¯¢é”™è¯¯:', error);
                }
            }, 3000);
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¥åº·çŠ¶æ€
        window.onload = checkHealth;
    </script>
</body>
</html>
